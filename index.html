<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lagos State Safety Commission – Certificate</title>
  <style>
    :root {
      --card-max: 480px;
      --radius: 20px;
      --shadow: 0 10px 30px rgba(0,0,0,.15);
      --muted: #6b7280;
      --brand: #111827;
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      background: #f3f4f6;
      color: #111827;
    }

    .bg-wrap {
      position: fixed; inset: 0; overflow: hidden; z-index: -1;
      background: linear-gradient(135deg, #e5e7eb, #c7d2fe);
    }
    .bg-wrap img {
      width: 100%; height: 100%; object-fit: cover;
      filter: blur(14px) saturate(1.05);
      transform: scale(1.06);
    }

    .page {
      min-height: 100%;
      display: grid;
      place-items: center;
      padding: 16px;
    }
    .card {
      width: 100%;
      max-width: var(--card-max);
      background: #fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px 18px 24px;
    }

    .header {
      display: grid;
      grid-template-columns: 56px 1fr 56px;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    .crest {
      width: 56px; height: 56px; object-fit: contain;
    }
    h1 {
      margin: 0; text-align: center; font-size: 18px; line-height: 1.2; font-weight: 700;
    }

    .subtitle {
      text-align: center; margin: 2px 0 14px; color: var(--muted); font-size: 13px;
    }

    .fields { margin: 10px 0 8px; }
    .row {
      display: grid; grid-template-columns: 135px 1fr; gap: 10px;
      padding: 10px 8px; border-bottom: 1px dashed #e5e7eb; align-items: start;
    }
    .row:last-child { border-bottom: 0; }
    dt { color: #374151; font-weight: 600; font-size: 14px; }
    dd { margin: 0; font-size: 15px; }

    .idline { margin-top: 12px; color: var(--muted); font-size: 12px; text-align: center; }

    .status { margin-top: 12px; padding: 10px; border-radius: 12px; font-size: 14px; }
    .status.info { background: #eef2ff; color: #3730a3; }
    .status.warn { background: #fff7ed; color: #9a3412; }
    .status.err  { background: #fee2e2; color: #991b1b; }

    .footer-actions {
      margin-top: 14px; display: flex; justify-content: center;
    }
    button {
      appearance: none; border: 0; background: #111827; color: white;
      padding: 10px 14px; border-radius: 999px; font-weight: 600; cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,.12);
    }

    @media (max-width: 420px) {
      .row { grid-template-columns: 1fr; gap: 4px; padding: 10px 4px; }
      dt { font-size: 13px; }
      dd { font-size: 14px; }
      .header { grid-template-columns: 40px 1fr 40px; }
      .crest { width: 40px; height: 40px; }
    }
  </style>
</head>
<body>
  <div class="bg-wrap">
    <img src="certificate-bg.png" alt="" onerror="this.style.display='none'" />
  </div>

  <div class="page">
    <article class="card" role="region" aria-labelledby="title">
      <div class="header">
        <img src="lagos_logo.png" class="crest" alt="Lagos crest" onerror="this.style.visibility='hidden'" />
        <h1 id="title">Lagos State Safety Commission</h1>
        <img src="lssc_logo.png" class="crest" alt="LSSC logo" onerror="this.style.visibility='hidden'" />
      </div>
      <p class="subtitle">Worksite Safety / Compliance Record</p>

      <dl class="fields">
        <div class="row"><dt>Name of Site</dt>     <dd id="siteName">—</dd></div>
        <div class="row"><dt>Site Address</dt>     <dd id="siteAddress">—</dd></div>
        <div class="row"><dt>Reference</dt>        <dd id="reference">—</dd></div>
        <div class="row"><dt>Date of Issue</dt>    <dd id="dateIssued">—</dd></div>
        <div class="row"><dt>Validity</dt>         <dd id="validity">—</dd></div>
        <div class="row"><dt>Processed by</dt>     <dd id="processedBy">—</dd></div>
        <div class="row"><dt>Site Contact</dt>     <dd id="siteContact">—</dd></div>
        <div class="row"><dt>Phone No.</dt>        <dd id="phoneNo">—</dd></div>
      </dl>

      <p class="idline">ID: <span id="docId">(loading)</span></p>
      <div id="status" class="status info">Loading certificate…</div>

      <div class="footer-actions">
        <button id="copyBtn" type="button">Copy link</button>
      </div>
    </article>
  </div>

  <script type="module">
    const params = new URLSearchParams(location.search);
    const docId = params.get('id');

    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");

    function setStatus(kind, text) {
      statusEl.className = `status ${kind}`;
      statusEl.textContent = text;
    }

    function formatMaybeTimestamp(v) {
      try {
        if (!v) return "N/A";
        if (typeof v?.toDate === 'function') return v.toDate().toLocaleDateString();
        if (typeof v === 'object' && 'seconds' in v) return new Date(v.seconds * 1000).toLocaleDateString();
        return String(v);
      } catch { return String(v); }
    }

    $("docId").textContent = docId || '—';
    const directLink = `${location.origin}/?id=${encodeURIComponent(docId || '')}`;
    $("copyBtn").addEventListener('click', async () => {
      try { 
        await navigator.clipboard.writeText(directLink); 
        setStatus('info', 'Link copied to clipboard'); 
      } catch { 
        setStatus('warn', 'Could not copy link'); 
      }
    });

    if (!docId) {
      setStatus('warn', 'No id query parameter found. Append ?id=YOUR_DOC_ID to the URL.');
      throw new Error('Missing id');
    }

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyB6l6lllyyJuzY3kVKxiA2H309Ca_3qIHk",
      authDomain: "lsscqr-72e18.firebaseapp.com",
      projectId: "lsscqr-72e18",
      storageBucket: "lsscqr-72e18.firebasestorage.app",
      messagingSenderId: "607942256026",
      appId: "1:607942256026:web:4af3740be761ca8cee4623",
      measurementId: "G-DML2K3EQE8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function loadCertificate(id) {
      try {
        setStatus('info', 'Fetching from Firestore…');
        const ref = doc(db, 'certificates', id);
        const snap = await getDoc(ref);
        if (!snap.exists()) {
          setStatus('err', 'Certificate not found');
          return;
        }
        const data = snap.data();
        $("siteName").textContent     = data.siteName     ?? 'N/A';
        $("siteAddress").textContent  = data.siteAddress  ?? 'N/A';
        $("reference").textContent    = data.reference    ?? 'N/A';
        $("dateIssued").textContent   = formatMaybeTimestamp(data.dateIssued);
        $("validity").textContent     = formatMaybeTimestamp(data.validity);
        $("processedBy").textContent  = data.processedBy  ?? 'N/A';
        $("siteContact").textContent  = data.contact  ?? 'N/A';
        $("phoneNo").textContent      = data.phone      ?? 'N/A';

        setStatus('info', 'Loaded');
        setTimeout(() => statusEl.style.display = 'none', 800);
      } catch (err) {
        console.error(err);
        setStatus('err', 'Error loading certificate');
      }
    }

    loadCertificate(docId);
  </script>
</body>
</html>
